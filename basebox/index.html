
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Building automation of a virtual machine (VM) from a server install image of ubuntu (ISO file)">
      
      
        <meta name="author" content="Daniel Jacob">
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../finalvm/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Base Box - Using JupyterHub within a VM and on the Cloud</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/pdfextra.css">
    
      <link rel="stylesheet" href="../css/lightbox.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#base-box" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-header__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Using JupyterHub within a VM and on the Cloud
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Base Box
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Using JupyterHub within a VM and on the Cloud
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Building the Base VM
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Building the Base VM
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-the-base-vm-base-box-for-vagrant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Building the base VM (Base box) for Vagrant
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-base-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating the base VM
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registering-a-box-on-vagrant-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      
        Registering a box on Vagrant Cloud
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../finalvm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building the Final VM
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../os-cloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using the Final VM on an Openstack cloud
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../google-cloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using the Final VM on Google Cloud Platform
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="base-box">Base Box<a class="headerlink" href="#base-box" title="Permanent link">&para;</a></h1>
<style>.md-typeset h1 {display: none;} .md-nav__item {font-size: medium}</style>

<h4 id="building-the-base-vm-base-box-for-vagrant">Building the base VM (Base box) for Vagrant<a class="headerlink" href="#building-the-base-vm-base-box-for-vagrant" title="Permanent link">&para;</a></h4>
<p>It is assumed that you have installed the <a href="https://www.packer.io/downloads" target="_blank">Packer</a> and <a href="https://www.vagrantup.com/downloads" target="_blank">Vagrant tools</a>, as well as the <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank">Oracle VirtualBox</a> virtualisation software.</p>
<p>The operations for creating a base box are documented online; you have to follow the <a href="https://developer.hashicorp.com/vagrant/docs/boxes/base" target="_blank">basic guide</a> and apply the provider-specific rules, namely for <a href="https://developer.hashicorp.com/vagrant/docs/providers/virtualbox/boxes" target="_blank">VirtualBox</a> . The procedure is somewhat tedious and, above all, an error can happen quickly. This is why we will use the Packer tool, which allows to fully automate the creation of a Vagrant base box by following the process illustrated by the figure below:</p>
<p><br></p>
<center>
<a href="../images/image1.png" data-lightbox="image1"><img src="../images/image1.png" width="600px"></a>
</center>
<p><br><br></p>
<p><strong>Note</strong>: All the scripts and other configuration files mentioned in this description can be found in free access under the <a href="https://github.com/inrae/jupyterhub-vm" target="_blank">GiHub INRAE repository</a>.</p>
<p>We are using <a href="http://cdimage.ubuntu.com/ubuntu/releases/20.04/release/" target="_blank">Ubuntu version 20.04</a> as a basis.</p>
<p>A Packer configuration is defined with a JSON file (box-config.json) with several sections: </p>
<ul>
<li><a href="https://developer.hashicorp.com/packer/docs/builders" target="_blank">builders</a>: is used to define the elements for creating the virtual machine from an ISO image.</li>
<li><a href="https://developer.hashicorp.com/packer/docs/provisioners" target="_blank">provisioners</a>: is used to define the software configuration from Shell scripts to provision the virtual machine.</li>
<li><a href="https://developer.hashicorp.com/packer/docs/post-processors" target="_blank">post-processors</a>: runs once the virtual machine is created and provisioned. This allows among other things to define the output format of the VM.</li>
</ul>
<p><strong>"builders" section</strong></p>
<ul>
<li>To build this section, it is often simpler to start from already functional examples and to modify the few elements specific to its configuration. A query in a search engine (e.g. Google) with the keywords "github packer ubuntu 20.04 virtualbox" will give you enough examples. So we started with <a href="https://github.com/geerlingguy/packer-boxes/tree/master/ubuntu2004" target="_blank">an example appropriate to our needs</a>, which we then adapted.</li>
<li>The VirtualBox box is made from an Ubuntu ISO specified by its URL (iso_urls) in order to create the VM in VirtualBox ("type": "virtualbox-iso") .</li>
<li>A "preseed" file (http/preseed.cfg) allows to configure the installation (see more info on <a href="https://wiki.debian.org/DebianInstaller/Preseed" target="_blank">preseeding</a> ). We have adapted the example by adding instructions concerning the root account and the network configuration.</li>
<li>We limited the maximum disk size to 18GB ("disk_size": 18432) so that the final VM can be accepted by the <a href="https://www.genouest.org/tag/cloud/" target="_blank">Genouest cloud</a>.</li>
</ul>
<p><strong>"provisioners" section</strong></p>
<p>This section allows to run Shell scripts after the virtual machine has booted properly and then its operating system installed. So it is in this step that we can configure the VM to be compatible with Vagrant and VirtualBox. A Shell script (scripts/setup.sh) is then executed in order to:</p>
<ul>
<li>install the drivers for VirtualBox</li>
<li>configure SSH accesses in compliance with Vagrant boxes. </li>
</ul>
<p><strong>"post-processors" section</strong></p>
<ul>
<li>Once the base virtual machine is fully installed and configured, it is simply exported to Vagrant format. </li>
</ul>
<h4 id="creating-the-base-vm">Creating the base VM<a class="headerlink" href="#creating-the-base-vm" title="Permanent link">&para;</a></h4>
<p>Before building, you must install these external plugins to ensure builds keep working </p>
<div class="highlight"><pre><span></span><code>$&gt; packer plugins install github.com/hashicorp/virtualbox
$&gt; packer plugins install github.com/hashicorp/vagrant
</code></pre></div>
<p>Once the configuration has been established, simply run Packer as follows:</p>
<div class="highlight"><pre><span></span><code>$&gt; packer build box-config.json
</code></pre></div>
<p>All the messages produced can be consulted on the <a href="https://github.com/inrae/jupyterhub-vm/blob/master/logs/packer.log" target="_blank">github repository</a>. The base VM after execution can be found under the builds directory.</p>
<p><br><br></p>
<h4 id="registering-a-box-on-vagrant-cloud">Registering a box on Vagrant Cloud<a class="headerlink" href="#registering-a-box-on-vagrant-cloud" title="Permanent link">&para;</a></h4>
<p>Vagrant Cloud provides an API that allows users to register their virtual machines (boxes) with Vagrant Cloud so that they can be reused by themselves or by other users.  The use of the <a href="https://www.vagrantup.com/docs/cli/cloud" target="_blank">API is described online</a>. </p>
<p>The registration of a virtual machine can only be done with the Vagrant format, i.e. a "box". A "box" is in fact a zipped archive file (TAR + GZIP) with the extension '.box'.
Registering a "box" consists of 5 steps:</p>
<ol>
<li>Creating an entry for the "box": at least the name of the box (boxname) must be specified. Its description is optional.</li>
<li>Creating a version: there may be several versions of the same entry; the version must be specified.</li>
<li>Creation of a provider: similarly, for an entry (boxname) and a version, there may be several associated providers; the provider must be specified.</li>
<li>Upload the box file.</li>
<li>Validate the box. (entry + version + provider)</li>
</ol>
<p>All of these steps can be done either via the Vagrant Cloud web interface, or through multiple API calls. In order to facilitate the automation of registrations, the Vagrant tool provides a 'cloud' functionality that allows you to register your box on Vagrant Cloud. This requires an account (called an 'organisation') to be created on Vagrant Cloud. </p>
<p>Example of invocation : </p>
<p><div class="highlight"><pre><span></span><code>$&gt; vagrant cloud auth login
</code></pre></div>
<div class="highlight"><pre><span></span><code> ...
Vagrant Cloud username: GAEV
Vagrant Cloud password: XXXXXXX
</code></pre></div></p>
<p><div class="highlight"><pre><span></span><code>$&gt; vagrant cloud publish GAEV/centos7-dd8Gb 1.0.0 virtualbox virtualbox-centos7_8Gb.box 
</code></pre></div>
<div class="highlight"><pre><span></span><code>You are about to create a box on Vagrant Cloud with the following options:
GAEV/centos7-dd8Gb (1.0.0) for virtualbox
Automatic Release:     true
Do you wish to continue? [y/N] y
Creating a box entry...
Creating a version entry...
Creating a provider entry...
Uploading provider with file /Vagrant/boxes/virtualbox-centos7_8Gb.box
Releasing box...
Complete!
tag:                  GAEV/centos7-dd8Gb
username:             GAEV
name:                 centos7-dd8Gb
private:              false
downloads:            0
created_at:           2020-07-25T17:53:04.340Z
updated_at:           2020-07-25T18:01:10.665Z
current_version:      1.0.0
providers:            virtualbox
</code></pre></div></p>
<p>The registered box can be viewed on <a href="https://portal.cloud.hashicorp.com/vagrant/discover/GAEV/ubuntu1804-dd18Gb" target="_blank">Vagrant Cloud</a>.</p>
<p><br><br><br></p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Daniel Jacob, INRAE, 2021
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../js/jquery-2.1.1.min.js"></script>
      
        <script src="../js/lightbox.min.js"></script>
      
        <script src="../js/mermaid.min.js"></script>
      
        <script src="../js/extra.js"></script>
      
    
  </body>
</html>